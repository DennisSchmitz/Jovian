#!/bin/bash
# shellcheck disable=SC1091
#set -euo pipefail
#set -v
#set -x

#load in standard vars
set -o allexport
[[ -f .env ]] && source .env
source bin/includes/functions
set +o allexport

eval "$(parse_yaml config/pipeline_parameters.yaml "params_")"
eval "$(parse_yaml config/config.yaml "configuration_")"

### Parse the jovian commandline arguments, if they are not part of jovian, they get send to Snakemake
POSITIONAL=()
while [[ $# -gt 0 ]]
do
    key="$1"
    case $key in
        -i|--input)
        INPUT_DIR="$2"
        export INPUT_DIR
        shift # Next
        shift # Next
        ;;
        -m|--mode)
        JOVIAN_MODE="$2"
        export JOVIAN_MODE
        shift #Next
        shift #Next
        ;;
        -h|--help)
        JOVIAN_HELP="TRUE"
        export JOVIAN_HELP
        shift # Next
        ;;
        -sh|--snakemake-help)
        SNAKEMAKE_HELP="TRUE"
        export SNAKEMAKE_HELP
        shift # Next
        ;;
        -ic|--install-dependencies)
        INSTALL_CONDA_ENVS="TRUE"
        export INSTALL_CONDA_ENVS
        shift # Next
        ;;
        -id|--install-databases)
        INSTALL_DB="TRUE"
        export INSTALL_DB
        shift # Next
        ;;
        --clean)
        CLEAN="TRUE"
        export CLEAN
        shift # Next
        ;;
        --archive)
        ARCHIVE="TRUE"
        export ARCHIVE
        shift # Next
        ;;
        -v|--version)
        SHOW_VERSION="TRUE"
        export SHOW_VERSION
        shift # Next
        ;;
        --start-nginx)
        START_NGINX="TRUE"
        export START_NGINX
        shift # Next
        ;;
        --stop-nginx)
        STOP_NGINX="TRUE"
        export STOP_NGINX
        shift # Next
        ;;
        --rebuild-archive)
        REBUILD_ARCHIVE="TRUE"
        export REBUILD_ARCHIVE
        shift # Next
        ;;
        --configure-jupyter)
        CONFIG_JUP="TRUE"
        export CONFIG_JUP
        shift # Next
        ;;
        --start-jupyter)
        START_JUPYTER="TRUE"
        export START_JUPYTER
        shift # Next
        ;;
        -vt|--virus-typing)
        VIRUS_TYPING="TRUE"
        WHICH_TT="$2"
        export VIRUS_TYPING
        export WHICH_TT
        shift # Next
        shift # Next
        ;;
        -vt-force|--virus-typing-force)
        VIRUS_TYPING="TRUE"
        FORCE_OVERWRITE_TT="TRUE"
        WHICH_TT="$2"
        export VIRUS_TYPING
        export FORCE_OVERWRITE_TT
        export WHICH_TT
        shift # Next
        shift # Next
        ;;
        -vt-help|--virus-typing-help)
        VIRUS_TYPING="TRUE"
        VIRUS_TYPING_HELP="TRUE"
        export VIRUS_TYPING
        export VIRUS_TYPING_HELP
        shift # Next
        ;;
        --make-sample-sheet)
        MAKE_SAMPLE_SHEET="TRUE"
        export MAKE_SAMPLE_SHEET
        shift # Next
        ;;
        -y)
        SKIP_CONFIRMATION="TRUE"
        export SKIP_CONFIRMATION
        shift # Next
        ;;
        -u|--unlock)
        SNAKEMAKE_UNLOCK="TRUE"
        export SNAKEMAKE_UNLOCK
        shift # Next
        ;;
        --update)
        JOVIAN_UPDATE="TRUE"
        CHANGE_VERSION="$2"
        export JOVIAN_UPDATE
        export CHANGE_VERSION
        shift # Next
        shift # Next
        ;;
        *) # Any other option
        POSITIONAL+=("$1") # save in array
        shift # Next
        ;;
    esac
done
set -- "${POSITIONAL[@]:-}" # Restores the positional arguments (i.e. without the case arguments above) which then can be called via `$@` or `$[0-9]` etc. These parameters are send to Snakemake.

### Check the jovian CLI arguments and do stuff

### Show Jovian version
if [ "${SHOW_VERSION}" == "TRUE" ]; then
    bash bin/includes/Version
    exit 0
fi

### Remove all Jovian output
if [ "${CLEAN:-}" == "TRUE" ]; then
    bash bin/includes/Clean
    exit 0
fi

### Print Jovian help message
if [ "${JOVIAN_HELP:-}" == "TRUE" ]; then
    bash bin/includes/help
    exit 0
fi

###############################################################################################################
##### Installation block                                                                                  #####
###############################################################################################################

### Pre-flight check: Assess availability of required files, conda and Jovian_master environment
if ! bash bin/includes/Pre_install_checker; then
    exit 1
fi

if ! bash bin/includes/Install_miniconda; then
    exit 1
else
    set -o allexport
    source "${HOME}"/.bashrc
    set +o allexport
fi

if ! bash bin/includes/Install_jovian-master; then
    exit 1
else
    set -o allexport
    source activate "${MASTER_NAME}"
    set +o allexport
    echo -e "Succesfully activated Jovian_master environment"
fi

        ###############################################################################################################
        ##### From this point onwards you can safely assume Conda is installed and Jovian_master is activated     #####
        ###############################################################################################################


if [ "${JOVIAN_UPDATE}" == "TRUE" ]; then
    if [ -z "${CHANGE_VERSION}" ]; then
        bash bin/includes/selfupdate master
        exit 0
    else
        bash bin/includes/selfupdate "${CHANGE_VERSION}"
        exit
    fi
fi

### Archiving of relevant data in a single tar.gz file
if [ "${ARCHIVE:-}" == "TRUE" ]; then
    bash bin/includes/Archive
    exit 0
fi

### Install databases, as specified via CLI argument '-id'
if [ "${INSTALL_DB:-}" == "TRUE" ]; then
    bash bin/includes/Databases
    exit 0
fi

bash bin/includes/Userconfig_DB

bash bin/includes/Userconfig_CM


###############################################################################################################
##### End of installation block, from this point onwards you can safely assume Jovian_master is activated #####
###############################################################################################################

### Virus typing block, as specified via CLI argument '--virus-typing'
if [ "${VIRUS_TYPING:-}" == "TRUE" ]; then
    if [ "${VIRUS_TYPING_HELP:-}" == "TRUE" ]; then
        bash bin/scripts/virus_typing.sh --help
        exit 0
    elif [ "${FORCE_OVERWRITE_TT:-}" == "TRUE" ]; then
        bash bin/scripts/virus_typing.sh ${WHICH_TT} --force
        exit 0
    else
        bash bin/scripts/virus_typing.sh "${WHICH_TT}"
        exit 0
    fi
fi

#TODO the syntax below doesn't work if there are multiple archives. should really fix at some point.
if [ "${REBUILD_ARCHIVE}" == "TRUE" ]; then
    if [ -e archive_*.tar.gz ]; then
        bin/includes/Rebuild_archive
    exit 0
    else
        echo -e "There's no Jovian-archive present."
        exit 0
    fi
fi

### Print Snakemake help
if [ "${SNAKEMAKE_HELP:-}" == "TRUE" ]; then
    line
    snakemake --help
    exit 0
fi

### Check if this required BLAST alias file is present in HOME
bash bin/includes/Make_ncbirc


### Installation of Jovian specific conda environments
bash bin/includes/Install_conda_envs

### Start and stop commands for nginx
if [ "${START_NGINX}" == "TRUE" ]; then
    (bin/start_nginx.sh start)
    exit 0
fi
if [ "${STOP_NGINX}" == "TRUE" ]; then
    nginx -s quit
    echo "nginx has been stopped"
    exit 0
fi

### * Auto configure the jupyter user profile and prepare it for direct use
if [ "${CONFIG_JUP}" == "TRUE" ]; then
    jt -t grade3 -fs 95 -altp -tfs 11 -nfs 115 -cellw 88% -T
    sed -i '1704,1706d' ~/.jupyter/custom/custom.css
    sed -i '35,55d' ~/.jupyter/custom/custom.css
    cat files/Jupyter_notebook/overrides.css >> ~/.jupyter/custom/custom.css
    jupyter notebook --generate-config
    sed -i "s/#c.NotebookApp.allow_remote_access = False/c.NotebookApp.allow_remote_access = True/g" ~/.jupyter/jupyter_notebook_config.py
    sed -i "s/#c.NotebookApp.ip = 'localhost'/c.NotebookApp.ip = '${SET_HOSTNAME}'/g" ~/.jupyter/jupyter_notebook_config.py
    sed -i "s/#c.NotebookApp.port = 8888/c.NotebookApp.port = 8888/g" ~/.jupyter/jupyter_notebook_config.py
    sed -i "s/#c.NotebookApp.open_browser = True/c.NotebookApp.open_browser = False/g" ~/.jupyter/jupyter_notebook_config.py
    sed -i "s/#c.NotebookApp.iopub_data_rate_limit = 1000000/c.NotebookApp.iopub_data_rate_limit = 100000000/g" ~/.jupyter/jupyter_notebook_config.py
    cp files/Jupyter_notebook/edit.json ~/.jupyter/nbconfig
    cp files/Jupyter_notebook/notebook.json ~/.jupyter/nbconfig
    cp files/Jupyter_notebook/tree.json ~/.jupyter/nbconfig
    echo "Done - Jupyter notebooks is configured and ready for use"
    exit 0
fi

if [ "${START_JUPYTER}" == "TRUE" ]; then
    cd /
    line
    minispacer
    # ! Give notices that jupyter is scary >:(
    printf "\e[1;91;40m\tJupyter notebooks will start in a moment                                                      \e[0m\n"
    printf "\e[1;91;40m\tPlease take note that Jupyter will keep running until you \e[4mEXPLICITLY\e[24m tell it to stop.         \e[0m\n"
    printf "\e[1;91;40m\tYou can stop Jupyter by pressing 'Ctrl + C' on your keyboard \e[4mtwice\e[24m                            \e[0m\n"
    minispacer
    sleep 3
    jupyter notebook
    exit 0
fi

if [ "${JOVIAN_MODE}" == "relaxed" ]; then
    #* Check the settings for the slidingwindow and change it when the setting does not match :5:20
    if [ "$params_Trimmomatic_quality_trimming_config" != "SLIDINGWINDOW:5:20" ]; then
        sed -i "s/    quality_trimming_config: $params_Trimmomatic_quality_trimming_config/    quality_trimming_config: SLIDINGWINDOW:5:20/g" config/pipeline_parameters.yaml
    fi
    #* Check the settings for the minlen filtering and change it when the setting does not match 250
    if [ "$params_scaffold_minLen_filter_minlen" != "250" ]; then
        sed -i "s/    minlen: $params_scaffold_minLen_filter_minlen/    minlen: 250/g" config/pipeline_parameters.yaml
    fi
    echo -e "Relaxed mode set..."

elif [ "${JOVIAN_MODE}" == "strict" ]; then
    #* Check the settings for the slidingwindow and change it when the setting does not match :5:30
    if [ "$params_Trimmomatic_quality_trimming_config" != "SLIDINGWINDOW:5:30" ]; then
        sed -i "s/    quality_trimming_config: $params_Trimmomatic_quality_trimming_config/    quality_trimming_config: SLIDINGWINDOW:5:30/g" config/pipeline_parameters.yaml
    fi
    #* Check the settings for the minlen filtering and change it when the setting does not match 500
    if [ "$params_scaffold_minLen_filter_minlen" != "500" ]; then
        sed -i "s/    minlen: $params_scaffold_minLen_filter_minlen/    minlen: 500/g" config/pipeline_parameters.yaml
    fi
    echo -e "Strict mode set..."

elif [ "${JOVIAN_MODE}" == "NONE" ]; then
    #* Check if parameters match with strict mode
    if [ "$params_Trimmomatic_quality_trimming_config" == "SLIDINGWINDOW:5:30" ] && [ "$params_scaffold_minLen_filter_minlen" == "500" ]; then
        echo -e "Jovian will run in strict mode..."
    fi
    #* Check if parameters match with relaxed mode
    if [ "$params_Trimmomatic_quality_trimming_config" == "SLIDINGWINDOW:5:20" ] && [ "$params_scaffold_minLen_filter_minlen" == "250" ]; then
        echo -e "Jovian will run in relaxed mode..."
    fi
    #* Check if parameters do not match with any of the predefined modes, exit if true
    if [[ ! "$params_Trimmomatic_quality_trimming_config" =~ ^(SLIDINGWINDOW:5:20|SLIDINGWINDOW:5:30)$ ]]; [[ ! "$params_scaffold_minLen_filter_minlen" =~ ^(250|500)$ ]]; then
        echo -e "Jovian will run in a custom mode"
    fi

elif [[ ! "${JOVIAN_MODE}" =~ ^(relaxed|strict)$ ]]; then
    #* Check if parameters match with strict mode
    if [ "$params_Trimmomatic_quality_trimming_config" == "SLIDINGWINDOW:5:30" ] && [ "$params_scaffold_minLen_filter_minlen" == "500" ]; then
        echo -e "Jovian is set to run in strict mode"
        exit 0
    fi
    #* Check if parameters match with relaxed mode
    if [ "$params_Trimmomatic_quality_trimming_config" == "SLIDINGWINDOW:5:20" ] && [ "$params_scaffold_minLen_filter_minlen" == "250" ]; then
        echo -e "Jovian is set to run in relaxed mode"
        exit 0
    fi
    #* Check if parameters do not match with any of the predefined modes, exit if true
    if [[ ! "$params_Trimmomatic_quality_trimming_config" =~ ^(SLIDINGWINDOW:5:20|SLIDINGWINDOW:5:30)$ ]]; [[ ! "$params_scaffold_minLen_filter_minlen" =~ ^(250|500)$ ]]; then
        echo -e "Jovian is set to run with a custom config/mode"
        exit 0
    fi
fi

### Pass other CLI arguments along to Snakemake
if [ ! -d "${INPUT_DIR}" ]; then
    minispacer
    echo -e "The input directory specified (${INPUT_DIR}) does not exist"
    echo -e "Please specify an existing input directory"
    exit 1
fi

### Generate sample sheet
if [ -n "$(ls -A "${INPUT_DIR}")" ]; then
    minispacer
    echo -e "Files in input directory (${INPUT_DIR}) are present"
    echo -e "Generating sample sheet..."
    bin/scripts/generate_sample_sheet.py "${INPUT_DIR}" > sample_sheet.yaml
    SHEET_SUCCESS="TRUE"
else
    minispacer
    echo -e "The input directory you specified (${INPUT_DIR}) exists but is empty...\nPlease specify a directory with input-data."
    exit 0
fi

### Checker for succesfull creation of sample_sheet
if [ "${SHEET_SUCCESS}" == "TRUE" ]; then
    echo -e "Succesfully generated the sample sheet"
    ready_for_start
else
    echo -e "Couldn't find files in the input directory that ended up being in a .FASTQ, .FQ or .GZ format"
    echo -e "Please inspect the input directory (${INPUT_DIR}) and make sure the files are in one of the formats listed below"
    echo -e ".fastq.gz (Zipped Fastq)"
    echo -e ".fq.gz (Zipped Fq)"
    echo -e ".fastq (Unzipped Fastq)"
    echo -e ".fq (unzipped Fq)"
    exit 1
fi

if [ "${MAKE_SAMPLE_SHEET}" == "TRUE" ]; then
    echo -e "Jovian_run:\n    identifier: ${UNIQUE_ID}" > config/variables.yaml
    echo -e "Server_host:\n    hostname: http://${SET_HOSTNAME}" >> config/variables.yaml
    echo -e "The sample sheet and variables file has now been created, you can now run the Jovian snakefile manually"
    exit 0
fi

if [ "${SNAKEMAKE_UNLOCK}" == "TRUE" ]; then
    printf "\nUnlocking working directory...\n"
    snakemake -s bin/Snakefile --profile "${PROFILE}" --unlock
    printf "\nDone.\n"
    exit 0
fi

### Actual snakemake command with checkers for required files. N.B. here the UNIQUE_ID and SET_HOSTNAME variables are set!
if [ -e sample_sheet.yaml ]; then
    echo -e "Starting snakemake"
    set +ue #turn off bash strict mode because snakemake and conda can't work with it properly
    echo -e "Jovian_run:\n    identifier: ${UNIQUE_ID}" > config/variables.yaml
    echo -e "Server_host:\n    hostname: http://${HOSTNAME}" >> config/variables.yaml
    eval $(parse_yaml config/variables.yaml "config_")
    snakemake -s bin/Snakefile --profile "${PROFILE}" ${@} && echo -e "\nUnique identifier for this Jovian run is: $config_Jovian_run_identifier "
    set -ue #turn bash strict mode back on
else
    echo -e "Sample_sheet.yaml could not be found"
    echo -e "This also means that Jovian was unable to generate a new sample sheet for you"
    echo -e "Please inspect the input directory (${INPUT_DIR}) and make sure the right files are present"
    exit 1
fi

exit 0 
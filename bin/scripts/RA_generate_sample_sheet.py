#!/usr/bin/env python3
"""Generate sample sheet for Jovian pipeline.

Usage:
  RA_generate_sample_sheet.py <source_dir>

<source_dir> is the directory containing the cleaned input fastq as
generated by Jovian core pipeline (default: data/cleaned_fastq/). 
Output will be a sample sheet in YAML, for example:

    sample1_id:
    pR1: data/cleaned_fastq/sample1_id_pR1.fq
    pR2: data/cleaned_fastq/sample1_id_pR2.fq
    unpaired: data/cleaned_fastq/sample1_id_unpaired.fq
    sample2_id:
    pR1: data/cleaned_fastq/sample2_id_pR1.fq
    pR2: data/cleaned_fastq/sample2_id_pR2.fq
    unpaired: data/cleaned_fastq/sample2_id_unpaired.fq
    ...
"""

import argparse
import pathlib
import re
import yaml


fq_pattern = re.compile("(.*)(_|\.)(pR1|pR2|unpaired).fq") 


def main(args):
    assert args.dir.is_dir(), "Argument must be a directory."
    
    samples = {}
    for file_ in args.dir.iterdir():
        if file_.is_dir():
            continue
        match = fq_pattern.fullmatch(file_.name)
        sample = samples.setdefault(match.group(1), {})
        sample["{}".format(match.group(3))] = str(file_)

    print(yaml.dump(samples, default_flow_style=False))


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("dir", type=pathlib.Path, 
                       help="Directory where input files are located")
    main(parser.parse_args())
